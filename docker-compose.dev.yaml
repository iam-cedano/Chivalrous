services:
  php-fpm:
    build: 
      context: ./dev
      dockerfile: Dockerfile.dev.php-fpm
      args:
        UID: ${UID:-1000}
        GID: ${GID:-1000}
    networks:
      - chivalrous-network
      - chivalrous-cache-network
    ports:
      - "9000:9000"
    volumes:
      - chivalrous-php-fpm-project:/var/www/html
    depends_on:
      - db
        
  nginx:
    build: 
      context: ./dev
      dockerfile: Dockerfile.dev.nginx
    ports:
      - "80:8080"
    volumes:
      - ./dev/nginx/nginx.conf:/etc/nginx/nginx.conf
      - ./dev/nginx/logs/:/var/log/nginx/
      - chivalrous-php-fpm-project:/var/www/html
    networks:
      - chivalrous-network
    depends_on:
      - php-fpm
  
  redis:
    build:
      context: ./dev
      dockerfile: Dockerfile.dev.redis
    ports:
      - "6379:6379"
    networks:
      - chivalrous-cache-network
    
  workspace:
    build:
      context: ./dev
      dockerfile: Dockerfile.dev.workspace
      args:
        UID: ${UID:-1000}
        GID: ${GID:-1000}
    volumes: 
      - chivalrous-php-fpm-project:/var/www/html
    networks:
      - chivalrous-network
      - chivalrous-cache-network
    tty: true
    env_file:
      - ./dev/workspace/.env.db
  
  db:
    build:
      context: ./dev
      dockerfile: Dockerfile.dev.db
    ports:
      - "3306:3306"
    volumes:  
      - chivalrous-db-dev:/var/lib/mysql
      - ./dev/db/scripts/:/docker-entrypoint-initdb.d/
    networks:
      - chivalrous-network
    env_file:
      - ./dev/db/.env.db
  
  # Optional: RedisInsight for Redis GUI management
  redis-insight:
    image: redislabs/redisinsight:latest
    ports:
      - "5540:5540"
    networks:
      - chivalrous-cache-network
    
volumes:
  chivalrous-php-fpm-project:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ./dev/php-fpm/project/

  chivalrous-db-dev:

networks:
  chivalrous-network:
    driver: bridge
  chivalrous-cache-network:
    driver: bridge