services:
  php-fpm:
    build: 
      context: ./dev
      dockerfile: Dockerfile.dev.php-fpm
      args:
        UID: ${UID:-1000}
        GID: ${GID:-1000}
    networks:
      - chivalrous-network
      - chivalrous-cache-network
    volumes:
      - project:/var/www/chivalrous.com/
    depends_on:
      - db
        
  nginx:
    build: 
      context: ./dev
      dockerfile: Dockerfile.dev.nginx
      args:
        UID: ${UID:-1000}
        GID: ${GID:-1000}
    ports:
      - "80:80"
    volumes:
      - ./dev/nginx/chivalrous.com/logs/:/var/log/nginx/chivalrous.com/
      - public:/var/www/chivalrous.com/public/
    networks:
      - chivalrous-network
    depends_on:
      - php-fpm
      - vite
  
  redis:
    build:
      context: ./dev
      dockerfile: Dockerfile.dev.redis
    networks:
      - chivalrous-cache-network
    
  workspace:
    tty: true
    build:
      context: ./dev
      dockerfile: Dockerfile.dev.workspace
      args:
        UID: ${UID:-1000}
        GID: ${GID:-1000}
    volumes: 
      - project:/var/www/chivalrous.com/
    networks:
      - chivalrous-network
      - chivalrous-cache-network
    env_file:
      - ./dev/workspace/.env.workspace

  vite: 
    build:
      context: ./dev
      dockerfile: Dockerfile.dev.vite 
    ports:
      - "5173:5173"
    volumes:
      - ./dev/php-fpm/project/:/var/www/chivalrous.com/
      - vite-node-modules:/var/www/chivalrous.com/node_modules
    env_file:
      - ./dev/vite/.env.vite
  db:
    build:
      context: ./dev
      dockerfile: Dockerfile.dev.db
    ports:
      - "3306:3306"
    volumes:  
      - db-dev:/var/lib/mysql
      - ./dev/db/scripts/:/docker-entrypoint-initdb.d/
    networks:
      - chivalrous-network
    env_file:
      - ./dev/db/.env.db
  
  # Optional: RedisInsight for Redis GUI management
  redis-insight:
    image: redislabs/redisinsight:latest
    ports:
      - "5540:5540"
    networks:
      - chivalrous-cache-network
    volumes:
      - redisinsight-data:/db
    
volumes:
  project:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ./dev/php-fpm/project/
  
  public:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ./dev/php-fpm/project/public/
  
  vite-node-modules:

  db-dev:
  redisinsight-data:

networks:
  chivalrous-network:
    driver: bridge
  chivalrous-cache-network:
    driver: bridge